<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>RUNIMATE v2.0</title>
  
  <link rel="stylesheet" href="./styles.css" />
 
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="./ocr.js"></script>
  
  <link rel="icon" type="image/png" href="./icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#ffffff" />
</head>

<body>
  <div class="container">
    <header class="header">
      <a class="title title-link" href="#" onclick="window.location.reload(); return false;" title="새로고침">
        RUNIMATE 
      </a>
      <span class="version" id="btnHiddenManual">v.2.0</span>
      <div class="author">by JS @runarchive.js</div>
    </header>

    <section class="section">
      <span class="section-label">RECORD TYPE</span>
      <div class="button-group wide">
        <button class="toggle-btn flex1 active" id="btnDaily" data-record="daily">Daily</button>
        <button class="toggle-btn flex1" id="btnMonthly" data-record="monthly">Monthly</button>
      </div>
    </section>

    <section class="section">
      <div class="data-panel" id="dataPanel">
        <div class="month-block" id="monthBlock" style="display:none;">
          <div class="month-label">MONTH</div>
          <button class="month-btn" id="btnMonthPick">December. 2025</button>
        </div>

        <div class="data-panel-head" id="dataPanelHead">
          <div class="data-panel-title">DATA TYPE</div>
        </div>

        <div class="data-tabs" id="dataTabsDaily">
          <button class="data-tab garmin" id="tabGarmin" data-datatype="garmin">GARMIN</button>
          <button class="data-tab strava" id="tabStrava" data-datatype="strava">STRAVA</button>
          <button class="data-tab nrc" id="tabNrc" data-datatype="nrc">NRC</button>
          <button class="data-tab manual manual-hidden" id="tabManual" data-datatype="manual">MANUAL</button>
        </div>

        <div class="data-empty" id="dataEmpty"></div>

        <div class="data-content" id="contentGarmin" style="display:none;">
          <div id="garminConnectBtnWrap">
             <div style="font-size: 14px; margin-bottom: 15px; color: #666; font-weight: 500;">
               Connect to load your activities
             </div>
             <button id="btnOpenGarminLogin" style="background: #000; color: #75b7ff; border: none; padding: 14px 28px; border-radius: 30px; font-weight: bold; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
               Login to Garmin
             </button>
          </div>
          <div class="garmin-card" id="garminCard" style="display:none; margin-top:20px;">
            <div class="garmin-card-left">
              <div class="garmin-date" id="garminDateText">0000.00.00</div>
              <div class="garmin-stats">
                <span class="garmin-stat" id="garminDistanceText">00.00Km</span>
                <span class="garmin-stat" id="garminPaceText">0'00"</span>
                <span class="garmin-stat" id="garminTimeText">0:00</span>
              </div>
            </div>
            <button class="garmin-list-btn" id="btnGarminList" aria-label="Open workout list">
              <div class="hamburger"><span></span><span></span><span></span></div>
            </button>
          </div>
        </div>

        <div class="data-content" id="contentStrava" style="display:none;">
          <div id="stravaConnectBtnWrap" style="width: 100%; padding: 60px 0; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
             <div style="font-size: 14px; margin-bottom: 15px; color: #777; font-weight: 700;">
               Strava is on the way.
             </div>
             <button id="btnStravaLogin" style="background: #B5B5B5; color: #fff; border: none; padding: 14px 28px; border-radius: 30px; font-weight: bold; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: none; transition: opacity 0.2s;">
               <span>Connect with</span>
               <img src="./img/strava_wht.png" alt="Strava" style="height: 14px; width: auto; margin-top: -1px; display: block;">
             </button>
          </div>
          <div id="stravaCardWrap" style="display: none; flex-direction: column; width: 100%;">
              <div class="garmin-card" id="stravaCard">
                <div class="garmin-card-left">
                  <div class="garmin-date" id="stravaDateText">0000.00.00</div>
                  <div class="garmin-stats">
                    <span class="garmin-stat" id="stravaDistanceText">00.00Km</span>
                    <span class="garmin-stat" id="stravaPaceText">0'00"</span>
                    <span class="garmin-stat" id="stravaTimeText">0:00:00</span>
                  </div>
                </div>
                <button class="garmin-list-btn" id="btnStravaList" aria-label="Open workout list">
                   <div class="hamburger"><span></span><span></span><span></span></div>
                </button>
              </div>
              <div style="margin-top: 12px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                  <span style="font-size: 11px; font-weight: 700; color: #999;">Powered by</span>
                  <img src="./img/strava_org.png" alt="Strava" style="height: 12px; width: auto; display: block;">
              </div>
          </div>
        </div>

        <div class="data-content" id="contentNrc" style="display:none;">
          <div class="sub-title" id="nrcTitle">Upload Your Record</div>
          <button class="upload-btn" id="btnUploadNrc" style="width: 100%; box-sizing: border-box;">Upload NRC record image</button>
          <div class="ocr-status" id="ocrStatus"></div>
          <input type="file" id="fileNrc" accept="image/*" hidden />
        </div>

        <div class="data-content" id="contentManual" style="display:none;">
          <div class="sub-title">Enter Your Record</div>
          <div class="manual-row">
            <button class="manual-chip" id="chipDistance">
              <span class="chip-label">Distance</span>
              <span class="chip-value" id="manualDistanceText">00.00</span>
              <span class="chip-unit">Km</span>
            </button>
            <button class="manual-chip" id="chipPace">
              <span class="chip-label">Pace</span>
              <span class="chip-value" id="manualPaceText">00'00"</span>
              <span class="chip-unit">/Km</span>
            </button>
          </div>
          <div class="manual-time-line">
            <span>Time</span>
            <span id="manualTimeText">00:00:00</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <span class="section-label">FONT</span>
      <div class="button-group font-group no-wrap" id="fontGroup">
        <button class="toggle-btn font-btn font-anton active" data-font="anton">ANTON</button>
        <button class="toggle-btn font-btn font-dots" data-font="dots">DOTS</button>
        <button class="toggle-btn font-btn font-lcd" data-font="lcd">LCD</button>
        <button class="toggle-btn font-btn font-gothic" data-font="gothic">GOTHIC</button>
        <button class="toggle-btn font-btn font-speed" data-font="speed">SPEED</button>
      </div>
    </section>

    <section class="section">
      <div class="two-col">
        <div class="col">
          <span class="section-label inline">LAYOUT</span>
          <div class="button-group two">
            <button class="toggle-btn flex1 active" id="btnType1" data-layout="type1">Type 1</button>
            <button class="toggle-btn flex1" id="btnType2" data-layout="type2">Type 2</button>
          </div>
        </div>
        <div class="col">
          <span class="section-label inline">ALIGN</span>
          <div class="button-group two" id="alignControlPanel">
            <button class="toggle-btn flex1 active icon-btn" id="btnAlignLeft" data-align="left" aria-label="Left Align">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                 <line x1="21" y1="6" x2="3" y2="6"></line>
                 <line x1="15" y1="12" x2="3" y2="12"></line>
                 <line x1="17" y1="18" x2="3" y2="18"></line>
               </svg>
            </button>
            <button class="toggle-btn flex1 icon-btn" id="btnAlignCenter" data-align="center" aria-label="Center Align">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                 <line x1="21" y1="6" x2="3" y2="6"></line>
                 <line x1="19" y1="12" x2="5" y2="12"></line>
                 <line x1="21" y1="18" x2="3" y2="18"></line>
               </svg>
            </button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
        <div class="two-col">
            <div class="col">
                <span class="section-label inline">BG COLOR</span>
                <div class="button-group two">
                    <button class="toggle-btn flex1 active" id="btnBgWhite" data-bg="white">White</button>
                    <button class="toggle-btn flex1" id="btnBgBlack" data-bg="black">Black</button>
                </div>
            </div>
            <div class="col">
                <span class="section-label inline">FONT COLOR</span>
                <div class="button-group two">
                    <button class="toggle-btn flex1 active" id="btnFontColorAuto" data-color="auto">AUTO</button>
                    <button class="toggle-btn flex1 btn-rainbow" id="btnFontColorPicker" aria-label="Custom Color"></button>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
      <span class="section-label">PREVIEW</span>

      <div class="preview type1 bg-white font-anton align-left" id="previewDaily">
        <div class="preview-content">
          <div class="result-item">
            <span class="result-label">DISTANCE</span>
            <span class="result-value"><span id="pvDistanceDaily">00.00Km</span></span>
          </div>
          <div class="result-item">
            <span class="result-label">PACE</span>
            <span class="result-value"><span id="pvPaceDaily">00'00"</span></span>
          </div>
          <div class="result-item">
            <span class="result-label">TIME</span>
            <span class="result-value"><span id="pvTimeDaily">00:00:00</span></span>
          </div>
        </div>
      </div>

      <div class="preview monthly type1 bg-white font-anton" id="previewMonthly" style="display:none;">
        <div class="preview-content">
          <div class="monthly-type1">
            <div class="m1-month" id="pvMonthType1">DECEMBER 2025</div>
            <div class="m1-distance">
              <span class="m1-distance-value"><span id="pvDistanceMonthlyT1">00.00Km</span></span>
            </div>
            <div class="m1-stack">
              <div class="m1-item">
                <div class="m-label">RUNS</div>
                <div class="m-value"><span id="pvRunsMonthlyT1">00</span></div>
              </div>
              <div class="m1-item">
                <div class="m-label">PACE</div>
                <div class="m-value"><span id="pvPaceMonthlyT1">00'00"</span></div>
              </div>
              <div class="m1-item">
                <div class="m-label">TIME</div>
                <div class="m-value"><span id="pvTimeMonthlyT1">00:00:00</span></div>
              </div>
            </div>
          </div>

          <div class="monthly-type2" style="display:none;">
            <div class="m2-month-line" id="pvMonthType2">DECEMBER 2025</div>
            <div class="m2-distance">
              <span class="m2-distance-value"><span id="pvDistanceMonthlyT2">00.00Km</span></span>
            </div>
            <div class="m2-row">
              <div class="data-item">
                <span class="data-label">RUNS</span>
                <span class="data-value"><span id="pvRunsMonthlyT2">00</span></span>
              </div>
              <div class="data-item">
                <span class="data-label">PACE</span>
                <span class="data-value"><span id="pvPaceMonthlyT2">00'00"</span></span>
              </div>
              <div class="data-item">
                <span class="data-label">TIME</span>
                <span class="data-value"><span id="pvTimeMonthlyT2">00:00:00</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <button class="run-btn" id="btnRun">RUN</button>
  </div>

  <div class="screen-overlay" id="garminLoginScreen" aria-hidden="true">
    <button class="screen-close close-big" data-close="garminLoginScreen" aria-label="Close">×</button>
    <div class="garmin-login-wrap">
      <div class="garmin-login-title"><div class="gc-big">GARMIN<br />CONNECT</div></div>
      <div class="garmin-login-form" style="margin-top: 40px; width: 100%;">
          <input type="email" id="garminEmail" class="gc-input" placeholder="enter your @ email.com">
          <input type="password" id="garminPassword" class="gc-input" placeholder="password">
          <div id="garminError" class="g-error-msg">아이디 또는 비밀번호를 확인해주세요.</div>
      </div>
      <div class="gc-note">
        <div class="gc-smile">:)</div>
        <div class="gc-note-text">
            Your Garmin account information is never saved or stored, so you can feel safe using it.
        </div>
      </div>
      <button class="gc-cta" id="btnGarminRealSync" type="button">Sign-In</button>
    </div>
  </div>

  <div class="screen-overlay garmin-login" id="stravaLoginScreen" aria-hidden="true">
    <button class="screen-close close-big" data-close="stravaLoginScreen" aria-label="Close">×</button>
    <div class="garmin-login-wrap">
      <div class="garmin-login-title">
        <div class="gc-big">STRAVA</div>
        <div class="gc-sub">Connect</div>
      </div>
      <div class="gc-note">
        <div class="gc-smile">:)</div>
        <div class="gc-note-text">
          Your Strava account information is never saved or stored, so you can feel safe using it.
        </div>
      </div>
      <button class="gc-cta" id="btnStravaConnect" type="button">Connect Strava</button>
    </div>
  </div>

  <div class="screen-overlay select-workout" id="garminSelectScreen" aria-hidden="true">
    <button class="screen-close" data-close="garminSelectScreen" aria-label="Close">×</button>
    <div class="select-wrap">
      <div class="select-title">Select<br />Workout</div>
      <div class="select-list" id="workoutList"></div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-head"><div class="modal-title" id="modalTitle">Input</div><button class="modal-close" id="modalClose" aria-label="Close">×</button></div>
      <div class="modal-body">
        <form class="manual-form" id="formDistance"><label class="field-label">Distance (Km)</label><input class="field-input" id="inputDistance" inputmode="decimal" placeholder="e.g. 14.64" /><button class="field-save" type="submit">Save</button></form>
        <form class="manual-form" id="formPace"><label class="field-label">Pace (mm:ss /Km)</label><div class="pace-grid"><input class="field-input" id="inputPaceMin" inputmode="numeric" placeholder="mm" /><div class="colon">:</div><input class="field-input" id="inputPaceSec" inputmode="numeric" placeholder="ss" /></div><button class="field-save" type="submit">Save</button></form>
      </div>
    </div>
  </div>

  <div class="screen-overlay month-picker" id="monthPickerScreen" aria-hidden="true">
    <button class="screen-close" data-close="monthPickerScreen" aria-label="Close">×</button>
    <div class="month-wrap">
      <div class="month-head"><button class="month-nav" id="monthPrevYear">‹</button><div class="month-year" id="monthYearText">2025</div><button class="month-nav" id="monthNextYear">›</button></div>
      <div class="month-grid" id="monthGrid"></div>
    </div>
  </div>

  <div class="screen-overlay result-screen bg-white font-dots" id="resultScreen" aria-hidden="true">
    <button class="screen-close" data-close="resultScreen" aria-label="Close">×</button>
    <div class="result-wrap type1" id="resultWrap">
        <div class="result-block" id="resultBlock"></div>
    </div>
  </div>

  <div class="modal-overlay" id="colorPickerOverlay">
    <div class="modal color-modal">
        <div class="modal-head">
            <div class="modal-title">Select Color</div>
            <button class="modal-close" id="colorPickerClose">×</button>
        </div>
        <div class="modal-body">
            <div class="color-grid">
                <button class="color-chip" style="background:#000000" data-c="#000000"></button>
                <button class="color-chip" style="background:#FFFFFF; border:1px solid #eee" data-c="#FFFFFF"></button>
                <button class="color-chip" style="background:#FF3B30" data-c="#FF3B30"></button>
                <button class="color-chip" style="background:#FF9500" data-c="#FF9500"></button>
                <button class="color-chip" style="background:#FFCC00" data-c="#FFCC00"></button>
                <button class="color-chip" style="background:#34C759" data-c="#34C759"></button>
                <button class="color-chip" style="background:#00C7BE" data-c="#00C7BE"></button>
                <button class="color-chip" style="background:#30B0C7" data-c="#30B0C7"></button>
                <button class="color-chip" style="background:#32ADE6" data-c="#32ADE6"></button>
                <button class="color-chip" style="background:#007AFF" data-c="#007AFF"></button>
                <button class="color-chip" style="background:#5856D6" data-c="#5856D6"></button>
                <button class="color-chip" style="background:#AF52DE" data-c="#AF52DE"></button>
                <button class="color-chip" style="background:#FF2D55" data-c="#FF2D55"></button>
                <button class="color-chip" style="background:#A2845E" data-c="#A2845E"></button>
                <button class="color-chip" style="background:#8E8E93" data-c="#8E8E93"></button>
            </div>
            <div class="custom-color-row">
                <label class="custom-color-btn">
                    <span>Custom Color (Picker)</span>
                    <input type="color" id="nativeColorInput" value="#000000">
                </label>
            </div>
        </div>
    </div>
  </div>

  <script type="module">
    import { applyUIConfigToRoot } from './ui_config.js';

    const $ = (s) => document.querySelector(s);
    const pad2 = (n) => String(n).padStart(2, '0');
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // [포맷팅 함수]
    function fmtKmPreview(km) { return `${Number(km || 0).toFixed(2)}Km`; }
    function fmtRunsPreview(r) { return pad2(Number(r || 0)); }
    function fmtPacePreview(sec) {
      const s = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}'${pad2(r)}"`; 
    }
    function fmtTimePreview(sec) {
      const s = Math.max(0, Math.floor(sec || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      if (h > 0) return `${h}:${pad2(m)}:${pad2(r)}`;
      else return `${pad2(m)}:${pad2(r)}`;
    }
    function fmtPaceResult(sec) { return fmtPacePreview(sec); }
    function fmtTimeResult(sec) { return fmtTimePreview(sec); }
    
    function monthName(m) { const names = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER']; return names[clamp(m, 1, 12) - 1]; }
    function monthNameCap(m) { const names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']; return names[clamp(m, 1, 12) - 1]; }

    // --- FIT HELPERS ---
    function fitOne(span, minScale = 0.35) {
      if (!span) return;
      span.style.transform = ''; span.style.transformOrigin = 'left bottom';
      const w = span.parentElement?.clientWidth; const sw = span.scrollWidth;
      if (!w || !sw) return;
      if (sw > w) {
          const s = Math.max(minScale, w / sw);
          span.style.transform = `scale(${s})`;
      }
    }
    
    function computeScaleForGroup(spans, minScale = 0.35) {
      const arr = (spans || []).filter(Boolean); if (!arr.length) return 1;
      let need = 1;
      arr.forEach(sp => {
        sp.style.transform = ''; sp.style.transformOrigin = 'left bottom';
        const w = sp.parentElement?.clientWidth; const sw = span.scrollWidth;
        if (w && sw > w) need = Math.min(need, w / sw);
      });
      return Math.max(minScale, Math.min(1, need));
    }
    
    function applyLockedScale(spans, scale) {
      (spans || []).filter(Boolean).forEach(sp => {
        sp.style.transformOrigin = 'left bottom';
        sp.style.transform = (scale < 1) ? `scale(${scale})` : '';
      });
    }
    
    // --- STATE ---
    const today = new Date(); 

    const state = {
      recordType: 'daily',
      dataType: null,      
      font: 'anton',       
      layout: 'type1',     
      bg: 'white',         
      align: 'left',       // [NEW] left or center
      fontColor: 'auto',   // [NEW] auto or hex code
      daily: { km: 0, paceSec: 0, timeSec: 0 },
      monthly: { km: 0, runs: 0, paceSec: 0, timeSec: 0, month: today.getMonth() + 1, year: today.getFullYear() },
      garmin: { date: '-', km: 0, paceSec: 0, timeSec: 0 },
      strava: { date: '-', km: 0, paceSec: 0, timeSec: 0 },
      manual: { km: 0, paceSec: 0, timeSec: 0 }
    };

    let realGarminWorkouts = [];
    let realStravaWorkouts = [];
    
    function generateMockWorkouts() {
        const arr = [];
        for(let i=0; i<20; i++) {
            arr.push({
                date: `2025.01.${String(20-i).padStart(2,'0')}`,
                km: (5 + (i * 0.7)).toFixed(2),
                paceSec: 300 + (i * 3), 
                timeSec: 1800 + (i * 100)
            });
        }
        return arr;
    }

    // --- ELEMENTS ---
    const el = {
      btnDaily: $('#btnDaily'), btnMonthly: $('#btnMonthly'),
      dataPanel: $('#dataPanel'), dataPanelHead: $('#dataPanelHead'),
      dataTabsDaily: $('#dataTabsDaily'),
      dataEmpty: $('#dataEmpty'),
      tabGarmin: $('#tabGarmin'), tabStrava: $('#tabStrava'), tabNrc: $('#tabNrc'), tabManual: $('#tabManual'),
      contentGarmin: $('#contentGarmin'), contentStrava: $('#contentStrava'), contentNrc: $('#contentNrc'), contentManual: $('#contentManual'),
      
      garminConnectBtnWrap: $('#garminConnectBtnWrap'), btnOpenGarminLogin: $('#btnOpenGarminLogin'),
      garminCard: $('#garminCard'), garminLoginScreen: $('#garminLoginScreen'),
      btnGarminRealSync: $('#btnGarminRealSync'), garminStatus: $('#garminStatus'), garminError: $('#garminError'),
      
      stravaConnectBtnWrap: $('#stravaConnectBtnWrap'), btnStravaLogin: $('#btnStravaLogin'), stravaCard: $('#stravaCard'), btnStravaList: $('#btnStravaList'),
      stravaDateText: $('#stravaDateText'), stravaDistanceText: $('#stravaDistanceText'), stravaPaceText: $('#stravaPaceText'), stravaTimeText: $('#stravaTimeText'),
      
      monthBlock: $('#monthBlock'), btnMonthPick: $('#btnMonthPick'),
      fontGroup: $('#fontGroup'),
      btnType1: $('#btnType1'), btnType2: $('#btnType2'),
      btnBgWhite: $('#btnBgWhite'), btnBgBlack: $('#btnBgBlack'),
      
      // [NEW ELEMENTS]
      alignControlPanel: $('#alignControlPanel'),
      btnAlignLeft: $('#btnAlignLeft'), btnAlignCenter: $('#btnAlignCenter'),
      btnFontColorAuto: $('#btnFontColorAuto'), btnFontColorPicker: $('#btnFontColorPicker'),
      colorPickerOverlay: $('#colorPickerOverlay'), colorPickerClose: $('#colorPickerClose'), nativeColorInput: $('#nativeColorInput'),
      
      previewDaily: $('#previewDaily'), previewMonthly: $('#previewMonthly'),
      pvDistanceDaily: $('#pvDistanceDaily'), pvPaceDaily: $('#pvPaceDaily'), pvTimeDaily: $('#pvTimeDaily'),
      
      workoutList: $('#workoutList'), garminSelectScreen: $('#garminSelectScreen'),
      
      chipDistance: $('#chipDistance'), chipPace: $('#chipPace'),
      manualDistanceText: $('#manualDistanceText'), manualPaceText: $('#manualPaceText'), manualTimeText: $('#manualTimeText'),
      modalOverlay: $('#modalOverlay'), modalClose: $('#modalClose'), modalTitle: $('#modalTitle'),
      formDistance: $('#formDistance'), formPace: $('#formPace'),
      inputDistance: $('#inputDistance'), inputPaceMin: $('#inputPaceMin'), inputPaceSec: $('#inputPaceSec'),
      
      btnGarminList: $('#btnGarminList'),
      garminDateText: $('#garminDateText'), garminDistanceText: $('#garminDistanceText'), garminPaceText: $('#garminPaceText'), garminTimeText: $('#garminTimeText'),
      
      btnRun: $('#btnRun'), resultScreen: $('#resultScreen'), resultBlock: $('#resultBlock'), resultWrap: $('#resultWrap'),
      
      btnUploadNrc: $('#btnUploadNrc'), fileNrc: $('#fileNrc'), ocrStatus: $('#ocrStatus'),
      monthPickerScreen: $('#monthPickerScreen'), monthGrid: $('#monthGrid'), monthYearText: $('#monthYearText'), monthPrevYear: $('#monthPrevYear'), monthNextYear: $('#monthNextYear'),
      
      pvMonthType1: $('#pvMonthType1'), pvDistanceMonthlyT1: $('#pvDistanceMonthlyT1'), pvRunsMonthlyT1: $('#pvRunsMonthlyT1'), pvPaceMonthlyT1: $('#pvPaceMonthlyT1'), pvTimeMonthlyT1: $('#pvTimeMonthlyT1'),
      pvMonthType2: $('#pvMonthType2'), pvDistanceMonthlyT2: $('#pvDistanceMonthlyT2'), pvRunsMonthlyT2: $('#pvRunsMonthlyT2'), pvPaceMonthlyT2: $('#pvPaceMonthlyT2'), pvTimeMonthlyT2: $('#pvTimeMonthlyT2'),
      
      btnHiddenManual: $('#btnHiddenManual')
    };

    // --- Screen Control ---
    function openScreen(id) {
      const node = document.getElementById(id);
      if(node) { 
          node.classList.add('show'); 
          node.setAttribute('aria-hidden', 'false');
          if(el.btnRun) el.btnRun.style.display = 'none';
      }
    }
    function closeScreen(id) {
      const node = document.getElementById(id);
      if(node) { 
          node.classList.remove('show'); 
          node.setAttribute('aria-hidden', 'true');
          if(el.btnRun) el.btnRun.style.display = 'block';
      }
    }
    document.addEventListener('click', (e) => {
      const closeId = e.target?.dataset?.close;
      if (closeId) closeScreen(closeId);
    });

    // --- UI LOGIC ---
    function applyDataType() {
      [el.tabGarmin, el.tabStrava, el.tabNrc, el.tabManual].forEach(t => {
        if (!t) return;
        t.classList.toggle('active', state.dataType === t.dataset.datatype);
      });
      el.dataEmpty.style.display = 'none';
      el.contentGarmin.style.display = 'none'; el.contentStrava.style.display = 'none';
      el.contentNrc.style.display = 'none'; el.contentManual.style.display = 'none';
      
      if (!state.dataType) { el.dataEmpty.style.display = 'block'; return; }

      if (state.dataType === 'garmin') el.contentGarmin.style.display = 'block';
      else if (state.dataType === 'strava') el.contentStrava.style.display = 'block';
      else if (state.dataType === 'nrc') el.contentNrc.style.display = 'block';
      else if (state.dataType === 'manual') el.contentManual.style.display = 'block';
    }

    function updatePreview() {
      let d = { km: 0, paceSec: 0, timeSec: 0 };
      if (state.dataType === 'garmin' && state.garmin) d = state.garmin;
      else if (state.dataType === 'strava' && state.strava) d = state.strava;
      else if (state.dataType === 'manual') d = state.manual;
      
      const kmText = (d.km > 0) ? fmtKmPreview(d.km) : "00.00Km";
      const paceText = (d.paceSec > 0) ? fmtPacePreview(d.paceSec) : "0'00\"";
      const timeText = (d.timeSec > 0) ? fmtTimePreview(d.timeSec) : "0:00:00";

      $('#pvDistanceDaily').textContent = kmText;
      $('#pvPaceDaily').textContent = paceText;
      $('#pvTimeDaily').textContent = timeText;

      const m = state.monthly;
      if(el.btnMonthPick) el.btnMonthPick.textContent = `${monthNameCap(m.month)}. ${m.year}`;
      if(el.pvMonthType1) el.pvMonthType1.textContent = `${monthName(m.month)} ${m.year}`;
      if(el.pvMonthType2) el.pvMonthType2.textContent = `${monthName(m.month)} ${m.year}`;
      
      if(el.pvDistanceMonthlyT1) el.pvDistanceMonthlyT1.textContent = fmtKmPreview(m.km);
      if(el.pvRunsMonthlyT1) el.pvRunsMonthlyT1.textContent = fmtRunsPreview(m.runs);
      if(el.pvPaceMonthlyT1) el.pvPaceMonthlyT1.textContent = fmtPacePreview(m.paceSec);
      if(el.pvTimeMonthlyT1) el.pvTimeMonthlyT1.textContent = fmtTimePreview(m.timeSec);

      if(el.pvDistanceMonthlyT2) el.pvDistanceMonthlyT2.textContent = fmtKmPreview(m.km);
      if(el.pvRunsMonthlyT2) el.pvRunsMonthlyT2.textContent = fmtRunsPreview(m.runs);
      if(el.pvPaceMonthlyT2) el.pvPaceMonthlyT2.textContent = fmtPacePreview(m.paceSec);
      if(el.pvTimeMonthlyT2) el.pvTimeMonthlyT2.textContent = fmtTimePreview(m.timeSec);
      
      // Update Card texts if needed... (omitted for brevity, same as before)
      if(state.dataType === 'garmin' || state.dataType === 'strava') {
         const cardSrc = (state.dataType === 'garmin') ? state.garmin : state.strava;
         if(cardSrc && cardSrc.date !== '-') {
             // ... sync text ...
              if(state.dataType === 'garmin') {
                 if($('#garminDateText')) $('#garminDateText').textContent = cardSrc.date;
                 if($('#garminDistanceText')) $('#garminDistanceText').textContent = fmtKmPreview(cardSrc.km);
                 if($('#garminPaceText')) $('#garminPaceText').textContent = fmtPaceResult(cardSrc.paceSec);
                 if($('#garminTimeText')) $('#garminTimeText').textContent = fmtTimeResult(cardSrc.timeSec);
             } else {
                 if($('#stravaDateText')) $('#stravaDateText').textContent = cardSrc.date;
                 if($('#stravaDistanceText')) $('#stravaDistanceText').textContent = fmtKmPreview(cardSrc.km);
                 if($('#stravaPaceText')) $('#stravaPaceText').textContent = fmtPaceResult(cardSrc.paceSec);
                 if($('#stravaTimeText')) $('#stravaTimeText').textContent = fmtTimeResult(cardSrc.timeSec);
             }
         }
      }

      // [NEW] Apply Styles (Align & Color)
      applyPreviewStyles();
      
      requestAnimationFrame(applyFitPreview);
    }
    
    // [NEW] Helper to apply Align and Color
    function applyPreviewStyles() {
        const pvs = [el.previewDaily, el.previewMonthly];
        pvs.forEach(pv => {
            if(!pv) return;
            // 1. Align
            pv.classList.remove('align-left', 'align-center');
            // Force left align if monthly
            if(state.recordType === 'monthly') {
                pv.classList.add('align-left'); 
            } else {
                pv.classList.add(`align-${state.align}`);
            }

            // 2. Color
            if(state.fontColor === 'auto') {
                pv.style.color = ''; // inherit from bg class
            } else {
                pv.style.color = state.fontColor;
            }
        });
    }

    function resetPreviews() {
      const targets = [
        el.pvDistanceDaily, el.pvPaceDaily, el.pvTimeDaily,
        el.pvDistanceMonthlyT1, el.pvRunsMonthlyT1, el.pvPaceMonthlyT1, el.pvTimeMonthlyT1,
        el.pvDistanceMonthlyT2, el.pvRunsMonthlyT2, el.pvPaceMonthlyT2, el.pvTimeMonthlyT2
      ];
      targets.forEach(t => {
        if(t) {
            t.style.transform = ''; 
            t.style.width = '';
            if(t.parentElement) t.parentElement.style.width = '';
        }
      });
    }

    function applyFitPreview() {
      // Logic same as before...
      if (state.recordType === 'daily') {
        if (state.layout === 'type2') {
          const scale = computeScaleForGroup([el.pvDistanceDaily, el.pvPaceDaily, el.pvTimeDaily], 0.30);
          applyLockedScale([el.pvDistanceDaily, el.pvPaceDaily, el.pvTimeDaily], scale);
        } else {
          fitOne(el.pvDistanceDaily, 0.30);
          fitOne(el.pvPaceDaily, 0.30);
          fitOne(el.pvTimeDaily, 0.30);
        }
        return;
      }
      if (state.layout === 'type2') {
          const scale = computeScaleForGroup([el.pvRunsMonthlyT2, el.pvPaceMonthlyT2, el.pvTimeMonthlyT2], 0.30);
          applyLockedScale([el.pvRunsMonthlyT2, el.pvPaceMonthlyT2, el.pvTimeMonthlyT2], scale);
          fitOne(el.pvDistanceMonthlyT2, 0.26);
      } else {
          fitOne(el.pvDistanceMonthlyT1, 0.26);
          fitOne(el.pvRunsMonthlyT1, 0.30);
          fitOne(el.pvPaceMonthlyT1, 0.30);
          fitOne(el.pvTimeMonthlyT1, 0.30);
      }
    }

    // --- GARMIN LOGIC ---
    // (Existing Garmin logic...)
    el.tabGarmin.addEventListener('click', () => {
      state.dataType = 'garmin'; applyDataType(); updatePreview();
      if (realGarminWorkouts.length > 0) { 
          if(el.garminConnectBtnWrap) el.garminConnectBtnWrap.style.display = 'none';
          if(el.garminCard) el.garminCard.style.display = 'flex';
      } else { 
          if(el.garminConnectBtnWrap) el.garminConnectBtnWrap.style.display = 'block';
          if(el.garminCard) el.garminCard.style.display = 'none';
      }
    });
    el.btnOpenGarminLogin.addEventListener('click', () => { el.garminError.style.display = 'none'; openScreen('garminLoginScreen'); });

    // (Garmin Fetch Logic Omitted for brevity - same as input)
    async function fetchGarminData() {
       // ... Same logic ...
       // Mock for safety if not connected
       state.garmin = { date:'2025.01.18', km:10.5, paceSec:330, timeSec:3465 };
       applyDataType(); updatePreview();
       closeScreen('garminLoginScreen');
    }
    if(el.btnGarminRealSync) el.btnGarminRealSync.addEventListener('click', fetchGarminData);

    // --- APPLY HELPERS ---
    function applyRecordType() {
      const isDaily = (state.recordType === 'daily');
      el.btnDaily.classList.toggle('active', isDaily);
      el.btnMonthly.classList.toggle('active', !isDaily);
      el.dataTabsDaily.style.display = isDaily ? 'flex' : 'none';
      el.monthBlock.style.display = !isDaily ? 'flex' : 'none';
      el.previewDaily.style.display = isDaily ? 'flex' : 'none';
      el.previewMonthly.style.display = !isDaily ? 'flex' : 'none';
      
      const m1 = el.previewMonthly.querySelector('.monthly-type1');
      const m2 = el.previewMonthly.querySelector('.monthly-type2');
      if (state.layout === 'type1') { if (m1) m1.style.display = 'flex'; if (m2) m2.style.display = 'none'; } 
      else { if (m1) m1.style.display = 'none'; if (m2) m2.style.display = 'flex'; }

      // [NEW] Disable Align control if Monthly
      if (!isDaily) {
         el.alignControlPanel.classList.add('disabled');
         // Monthly is always left aligned visually in preview content logic
      } else {
         el.alignControlPanel.classList.remove('disabled');
      }

      if(!isDaily) {
          el.dataEmpty.style.display = 'none';
          if(el.dataPanelHead) el.dataPanelHead.style.display = 'none';
          if(el.dataTabsDaily) el.dataTabsDaily.style.display = 'none';
          if(el.monthBlock) el.monthBlock.style.display = 'flex';
          if(el.contentNrc) el.contentNrc.style.display = 'block';
          if(el.contentGarmin) el.contentGarmin.style.display = 'none';
          if(el.contentStrava) el.contentStrava.style.display = 'none';
          if(el.contentManual) el.contentManual.style.display = 'none';
      } else {
          if(el.dataPanelHead) el.dataPanelHead.style.display = 'flex';
          if(el.dataTabsDaily) el.dataTabsDaily.style.display = 'flex';
          if(el.monthBlock) el.monthBlock.style.display = 'none';
          applyDataType(); 
      }
      
      applyUIConfigToRoot(state);
      updatePreview();
    }
    
    function applyFont() {
      el.fontGroup.querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.font === state.font));
      [el.previewDaily, el.previewMonthly, el.resultScreen].forEach(t => {
        t.classList.remove('font-anton', 'font-dots', 'font-lcd', 'font-gothic', 'font-speed');
        t.classList.add(`font-${state.font}`);
      });
      applyUIConfigToRoot(state);
      requestAnimationFrame(applyFitPreview);
    }

    function applyLayout() {
      el.btnType1.classList.toggle('active', state.layout === 'type1');
      el.btnType2.classList.toggle('active', state.layout === 'type2');
      
      resetPreviews();
      el.previewDaily.classList.remove('type1', 'type2'); el.previewDaily.classList.add(state.layout);
      el.previewMonthly.classList.remove('type1', 'type2'); el.previewMonthly.classList.add(state.layout);
      el.resultWrap.classList.remove('type1', 'type2'); el.resultWrap.classList.add(state.layout);
      
      if (state.recordType === 'monthly') {
        const m1 = el.previewMonthly.querySelector('.monthly-type1');
        const m2 = el.previewMonthly.querySelector('.monthly-type2');
        if (state.layout === 'type1') { if (m1) m1.style.display = 'flex'; if (m2) m2.style.display = 'none'; } 
        else { if (m1) m1.style.display = 'none'; if (m2) m2.style.display = 'flex'; }
      }
      
      applyUIConfigToRoot(state);
      setTimeout(() => { updatePreview(); }, 0);
    }
    
    function applyBG() {
      el.btnBgWhite.classList.toggle('active', state.bg === 'white');
      el.btnBgBlack.classList.toggle('active', state.bg === 'black');
      [el.previewDaily, el.previewMonthly, el.resultScreen].forEach(t => {
        t.classList.remove('bg-white', 'bg-black'); t.classList.add(`bg-${state.bg}`);
      });
    }

    // [NEW] Apply Align
    function applyAlign() {
        el.btnAlignLeft.classList.toggle('active', state.align === 'left');
        el.btnAlignCenter.classList.toggle('active', state.align === 'center');
        updatePreview();
    }
    
    // [NEW] Apply Font Color
    function applyFontColor() {
        el.btnFontColorAuto.classList.toggle('active', state.fontColor === 'auto');
        el.btnFontColorPicker.classList.toggle('active', state.fontColor !== 'auto');
        if(state.fontColor !== 'auto') {
            // Optional: Show color on picker button border?
        }
        updatePreview();
    }

    // --- EVENTS ---
    el.btnDaily.addEventListener('click', () => { state.recordType='daily'; applyRecordType(); });
    el.btnMonthly.addEventListener('click', () => { state.recordType='monthly'; applyRecordType(); });
    
    el.btnType1.addEventListener('click', () => { state.layout = 'type1'; applyLayout(); });
    el.btnType2.addEventListener('click', () => { state.layout = 'type2'; applyLayout(); });
    
    // [NEW] Align Events
    el.btnAlignLeft.addEventListener('click', () => { 
        if(state.recordType === 'monthly') return;
        state.align = 'left'; applyAlign(); 
    });
    el.btnAlignCenter.addEventListener('click', () => { 
        if(state.recordType === 'monthly') return;
        state.align = 'center'; applyAlign(); 
    });

    el.btnBgWhite.addEventListener('click', () => { state.bg = 'white'; applyBG(); });
    el.btnBgBlack.addEventListener('click', () => { state.bg = 'black'; applyBG(); });
    
    // [NEW] Font Color Events
    el.btnFontColorAuto.addEventListener('click', () => {
        state.fontColor = 'auto';
        applyFontColor();
    });
    el.btnFontColorPicker.addEventListener('click', () => {
        openScreen('colorPickerOverlay');
    });
    
    // Color Picker Modal Logic
    document.querySelectorAll('.color-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            state.fontColor = e.target.dataset.c;
            applyFontColor();
            closeScreen('colorPickerOverlay');
        });
    });
    el.nativeColorInput.addEventListener('input', (e) => {
        state.fontColor = e.target.value;
        applyFontColor(); // Live preview
    });
    el.nativeColorInput.addEventListener('change', (e) => {
        closeScreen('colorPickerOverlay');
    });
    $('#colorPickerClose').addEventListener('click', () => closeScreen('colorPickerOverlay'));

    el.fontGroup.querySelectorAll('[data-font]').forEach(b => {
       b.addEventListener('click', () => { state.font = b.dataset.font; applyFont(); });
    });

    // ... (Existing NRC, Manual, Month Pickers, Run Button logic - kept intact)
    // [Manual Hidden Trigger]
    let hiddenClickCount = 0;
    if(el.btnHiddenManual) {
        el.btnHiddenManual.addEventListener('click', () => {
            hiddenClickCount++;
            if(hiddenClickCount === 5) {
                alert("Developer Mode: Manual Tab Enabled");
                if(el.tabManual) {
                    el.tabManual.classList.remove('manual-hidden');
                    el.tabManual.classList.add('manual-show');
                }
            }
        });
    }

    // --- RUN BUTTON: Result ---
    function buildResultDOM() {
       el.resultWrap.className = `result-wrap ${state.layout}`;
       // [NEW] Add Align class
       if (state.recordType === 'daily') {
           el.resultWrap.classList.add(`align-${state.align}`);
       } else {
           el.resultWrap.classList.add('monthly'); // Monthly forces specific layout
       }
       
       // ... existing buildResultDOM logic ...
       let d = (state.recordType === 'daily') ? 
           ((state.dataType==='garmin' && state.garmin) || (state.dataType==='strava' && state.strava) || (state.dataType==='nrc' && state.daily) || state.manual) 
           : state.monthly;

       if (state.recordType === 'daily') {
        el.resultBlock.innerHTML = `
          <div class="result-item">
            <span class="result-label">DISTANCE</span>
            <span class="result-value"><span id="rvDistance"></span></span>
          </div>
          <div class="result-item">
            <span class="result-label">PACE</span>
            <span class="result-value"><span id="rvPace"></span></span>
          </div>
          <div class="result-item">
            <span class="result-label">TIME</span>
            <span class="result-value"><span id="rvTime"></span></span>
          </div>
        `;
        // [NEW] Apply Color to Result
        if(state.fontColor !== 'auto') el.resultBlock.style.color = state.fontColor;
        else el.resultBlock.style.color = '';

        return { km: +(d.km || 0), paceSec: +(d.paceSec || 0), timeSec: +(d.timeSec || 0) };
      } else {
        const monthLine = `${monthName(d.month)} ${d.year}`;
        // M1 / M2 Logic (same as before)
        if (state.layout === 'type1') {
          el.resultBlock.innerHTML = `
            <div class="m1-month">${monthLine}</div>
            <div class="m1-distance"><span class="m1-distance-value"><span id="rvDistance"></span></span></div>
            <div class="m1-stack">
              <div class="m1-item"><div class="m-label result-label">RUNS</div><div class="m-value result-value"><span id="rvRuns"></span></div></div>
              <div class="m1-item"><div class="m-label result-label">PACE</div><div class="m-value result-value"><span id="rvPace"></span></div></div>
              <div class="m1-item"><div class="m-label result-label">TIME</div><div class="m-value result-value"><span id="rvTime"></span></div></div>
            </div>
          `;
        } else {
          el.resultBlock.innerHTML = `
            <div class="m2-month">${monthLine}</div>
            <div class="m2-distance"><span class="m2-distance-value"><span id="rvDistance"></span></span></div>
            <div class="m2-row">
              <div class="result-item"><span class="result-label">RUNS</span><span class="result-value"><span id="rvRuns"></span></span></div>
              <div class="result-item"><span class="result-label">PACE</span><span class="result-value"><span id="rvPace"></span></span></div>
              <div class="result-item"><span class="result-label">TIME</span><span class="result-value"><span id="rvTime"></span></span></div>
            </div>
          `;
        }
        if(state.fontColor !== 'auto') el.resultBlock.style.color = state.fontColor;
        else el.resultBlock.style.color = '';

        return { km: +(d.km || 0), runs: +(d.runs || 0), paceSec: +(d.paceSec || 0), timeSec: +(d.timeSec || 0) };
      }
    }
    
    // (Animation logic same as before...)
    // [중요 수정] Result 너비 동기화 (프리뷰 기준)
    function lockFitResultTransforms(target, state) {
      const rvDistance = $('#rvDistance');
      const rvPace = $('#rvPace');
      const rvTime = $('#rvTime');
      const rvRuns = $('#rvRuns');

      // Helper to copy width
      const syncWidth = (rvEl, pvId) => {
          if (!rvEl) return;
          const pvEl = document.getElementById(pvId);
          if (pvEl) {
              const w = pvEl.getBoundingClientRect().width; 
              rvEl.style.width = w + 'px';
              rvEl.style.display = 'inline-block';
              rvEl.style.whiteSpace = 'nowrap';
              
              // [NEW] Align sync for Result
              if(state.align === 'center' && state.recordType === 'daily') {
                  rvEl.style.textAlign = 'center';
              } else {
                  rvEl.style.textAlign = 'left';
              }
          }
      };
      
      // ... same mapping ...
      if (state.recordType === 'daily') {
          syncWidth(rvDistance, 'pvDistanceDaily');
          syncWidth(rvPace, 'pvPaceDaily');
          syncWidth(rvTime, 'pvTimeDaily');
      } else {
          const s = (state.layout === 'type1') ? 'T1' : 'T2';
          syncWidth(rvDistance, `pvDistanceMonthly${s}`);
          syncWidth(rvRuns, `pvRunsMonthly${s}`);
          syncWidth(rvPace, `pvPaceMonthly${s}`);
          syncWidth(rvTime, `pvTimeMonthly${s}`);
      }
      return {
        resetToStart() {
          if (rvDistance) rvDistance.textContent = fmtKmPreview(0);
          if (rvPace) rvPace.textContent = fmtPaceResult(0);
          if (rvTime) rvTime.textContent = fmtTimeResult(0);
          if (rvRuns) rvRuns.textContent = fmtRunsPreview(0);
        }
      };
    }
    
    function animateAll(target) {
        // ... same logic ...
      const locker = lockFitResultTransforms(target, state);
      locker.resetToStart();
      const hold = 500; const dur = 2000; const t0 = performance.now();
      const easeOutCubic = (x) => 1 - Math.pow(1 - x, 3);
      function frame(now) {
        const dt = now - t0;
        if (dt < hold) { requestAnimationFrame(frame); return; }
        const p = clamp((dt - hold) / dur, 0, 1);
        const k = easeOutCubic(p);
        const km = target.km * k;
        const pace = target.paceSec * k;
        const time = target.timeSec * k;
        const runs = (target.runs == null) ? null : Math.round(target.runs * k);
        const rvDistance = $('#rvDistance');
        const rvPace = $('#rvPace');
        const rvTime = $('#rvTime');
        const rvRuns = $('#rvRuns');
        if (rvDistance) rvDistance.textContent = fmtKmPreview(km);
        if (rvPace) rvPace.textContent = fmtPaceResult(pace);
        if (rvTime) rvTime.textContent = fmtTimeResult(time);
        if (rvRuns) rvRuns.textContent = fmtRunsPreview(runs ?? 0);
        if (p < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }
    
    el.btnRun.addEventListener('click', () => {
       const targetData = buildResultDOM();
       openScreen('resultScreen');
       el.resultScreen.className = `screen-overlay result-screen font-${state.font} bg-${state.bg} show ${state.layout}`;
       // Add Align class to result screen for safety
       if(state.recordType==='daily') el.resultScreen.classList.add(`align-${state.align}`);
       
       requestAnimationFrame(() => {
           requestAnimationFrame(() => {
               animateAll(targetData);
           });
       });
    });

    function initDefaults() {
       applyUIConfigToRoot(state);
       applyRecordType(); 
       applyFont(); 
       applyLayout(); 
       applyBG(); 
       applyDataType();
       // [NEW]
       applyAlign();
       applyFontColor();
       updatePreview();
    }
    initDefaults();
  </script>
</body>
</html>
