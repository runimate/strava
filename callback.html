<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Runimate - Auth</title>
    <style>
        body { background: #000; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }
    </style>
</head>
<body>
    <h2 id="status">ëŸ¬ë‹ˆë©”ì´íŠ¸ ì—°ê²° ì¤‘... ğŸƒâ€â™‚ï¸</h2>

    <script>
        async function getToken() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (!code) {
                document.getElementById('status').innerText = "ì¸ì¦ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                setTimeout(() => location.href = '/', 2000);
                return;
            }

            try {
                // 1. ìš°ë¦¬ê°€ ë§Œë“¤ ë°±ì—”ë“œ APIë¡œ 'ì½”ë“œ'ë¥¼ ë³´ëƒ„
                const res = await fetch(`/api/strava/token?code=${code}`);
                const data = await res.json();

                if (data.access_token) {
                    // 2. ë°›ì€ í† í°ì„ ì €ì¥ (ì´ì œ ì´ í† í°ìœ¼ë¡œ í™œë™ ë‚´ì—­ì„ ê°€ì ¸ì˜µë‹ˆë‹¤)
                    localStorage.setItem('strava_access_token', data.access_token);
                    localStorage.setItem('strava_refresh_token', data.refresh_token);
                    localStorage.setItem('strava_expires_at', data.expires_at);

                    document.getElementById('status').innerText = "ì—°ê²° ì„±ê³µ! ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.";
                    // 3. ë©”ì¸ í˜ì´ì§€(í˜¹ì€ ë°ì´í„° ë³´ëŠ” í˜ì´ì§€)ë¡œ ì´ë™
                    setTimeout(() => location.href = '/count.html', 1000); 
                } else {
                    throw new Error('í† í° ë°œê¸‰ ì‹¤íŒ¨');
                }
            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message;
            }
        }

        getToken();
    </script>
</body>
</html>
